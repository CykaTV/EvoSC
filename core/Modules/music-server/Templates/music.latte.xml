<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<manialink id="SongInformation" version="3">
<frame pos="120 80" scale="0.8">
    <quad pos="0 0" z-index="-2" size="50 10" style="Bgs1" substyle="BgDialogBlur"/>
    <quad pos="0 0" z-index="-1" size="50 10" bgcolor="0001"/>
    <quad pos="40 0" z-index="0" size="10 10" bgcolor="18f3"/>
    <quad pos="40 0" z-index="1" size=".2 10" bgcolor="18f9"/>
    <label pos="45 -5" valign="center" halign="center" textsize="3" size="6 6" text="♫" textcolor="ffff"/>

    <label pos="2 -1.5" z-index="1" size="36 3" text="{$song->title ?? $song->file}" halign="left" textcolor="fffe" textsize="1"/>
    <label pos="38 -6.8" z-index="1" size="16 3" text="{$song->artist}" halign="right" textcolor="fff9" textsize="0.45"/>

    <quad pos="2 -5.2" size="36 0.4" bgcolor="0003" />
    <quad id="bar" pos="2 -5.2" size="0 0.4" bgcolor="fffa" />

    <quad pos="40 0" size="10 10" action="ms.menu.showpage" />

    <frame pos="20 -7" scale="0.4">
        <label pos="-7 0" text="" action="music.next" />
        <label id="pause" pos="-14 0" text="" ScriptEvents="1" />
        <label id="play" pos="-14 0" text="" ScriptEvents="1" />

        <label id="passed" pos="-45 0" z-index="1" size="31 3" text="{$song->length}" textcolor="fffe" textsize="4"/>
    </frame>

    <audio id="audio" pos="2000 2000" data="{$song->url}" play="1" looping="1" ScriptEvents="1" />


    <script><!--
            #Include "MathLib" as MathLib
            main() {
            declare bar <=> (Page.MainFrame.GetFirstChild("bar") as CMlQuad);
            declare audio <=> (Page.MainFrame.GetFirstChild("audio") as CMlMediaPlayer);
            declare pauseButton <=> (Page.MainFrame.GetFirstChild("pause") as CMlLabel);
            declare playButton <=> (Page.MainFrame.GetFirstChild("play") as CMlLabel);
            declare timePassedLabel <=> (Page.MainFrame.GetFirstChild("passed") as CMlLabel);

            declare Integer timeLeft = 0;
            declare Integer timePassed = 0;
            declare Integer playtimeMinutes = 0;
            declare Integer playtimeSeconds = 0;
            declare Text length = {$song->length};
            declare Integer lengthInSeconds = {$lengthInSeconds};
            declare Integer timeEnd = CurrentTime + {$lengthInSeconds}000;

            playButton.Visible = False;

            while (True) {
                yield;

                foreach (Event in PendingEvents) {
                    if(Event.Type == CMlEvent::Type::MouseClick){
                        if(Event.ControlId == "pause"){
                            audio.Stop();
                            pauseButton.Visible = False;
                            playButton.Visible = True;
                        }
                        if(Event.ControlId == "play"){
                            audio.Play();
                            pauseButton.Visible = True;
                            playButton.Visible = False;
                        }
                    }
                }

                timeLeft = (timeEnd/1000) - (CurrentTime/1000);
                timePassed =  lengthInSeconds - timeLeft;

                playtimeMinutes = MathLib::FloorInteger(timePassed/60.0);
                playtimeSeconds = timePassed - (playtimeMinutes*60);

                if(playtimeSeconds < 10){
                    timePassedLabel.SetText(playtimeMinutes ^ ":0" ^ playtimeSeconds ^ " / " ^ length);
                }else{
                    timePassedLabel.SetText(playtimeMinutes ^ ":" ^ playtimeSeconds ^ " / " ^ length);
                }

                if(timePassed > 0){
                    bar.Size = <(timePassed / (lengthInSeconds * 1.0))*36.0,0.4>;

                    if(timePassed >= lengthInSeconds){
                        TriggerPageAction("music.next");
                    }
                }

                sleep(100);
            }
        }
        --></script>
</frame>

</manialink>