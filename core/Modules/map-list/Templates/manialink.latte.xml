<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<manialink name="ESC:Maps:main" id="esc_maps" version="3">
    <frame id="maps-container" pos="-75.5 45" hidden="1">
        <quad pos="0 2.5" size="151 11" bgcolor="{header_color()|noescape}c" />
        <quad pos="0 -8" size="151 0.5" bgcolor="{header_color()|noescape}f" z-index="2" />
        <quad pos="0 2.5" size="151 101" bgcolor="{background_color()|noescape}" opacity="0.75" />
        <quad pos="0 -8.5" size="151 90" style="Bgs1" substyle="BgDialogBlur" />
        <label pos="1.5 -0.4" size="20 3" text=" Maps" valign="center" textsize="1.2" z-index="2" textcolor="ffff" />
        <label class="close" pos="148 -0.5" size="6 6" text="❌" textsize="1.2" z-index="2" valign="center" halign="center" textcolor="ffff" focusareacolor1="0000" focusareacolor2="{config('colors.ui.header')}f" ScriptEvents="1" />

        <frame id="navbar" pos="0 -3" z-index="2">
            <frame pos="10 -3" z-index="2">
                <quad id="maps-button" class="nav-button button" data-page="0" valign="center" halign="center" size="15 4" bgcolor="{header_color()|noescape}" opacity="0.2" z-index="-1" ScriptEvents="1" />
                <label textcolor="ffff" textsize="0.3" valign="center" halign="center" text="Maplist" />
            </frame>

            <frame pos="27 -3" z-index="5">
                <quad class="nav-button button" data-page="1" valign="center" halign="center" size="15 4" bgcolor="{header_color()|noescape}" opacity="0.2" z-index="-1" ScriptEvents="1" />
                <label textcolor="ffff" textsize="0.3" valign="center" halign="center" text="Favorites" />
            </frame>

            <frame pos="44 -3" z-index="5">
                <quad class="nav-button button" data-page="2" valign="center" halign="center" size="15 4" bgcolor="{header_color()|noescape}" opacity="0.2" z-index="-1" ScriptEvents="1" />
                <label textcolor="ffff" textsize="0.3" valign="center" halign="center" text="Queued maps" />
            </frame>
        </frame>

        <framemodel id="Map">
            <quad class="row" valign="center" size="162 4" bgcolor="{header_color()|noescape}" opacity="0" ScriptEvents="1" />
            <quad valign="center" pos="1 0" size="40 3" bgcolor="0000" />
            <quad valign="center" pos="52 0" size="30 3" bgcolor="0000" />
            <quad valign="center" pos="73 0" size="30 3" bgcolor="0000" />
            <label pos="1 0" valign="center" size="40 3" text="map name lol asdfasdasdsad" textcolor="ffff" textsize="0.6" z-index="1" />
            <label pos="52 0" valign="center" size="30 3" text="map author name comes here" textcolor="ffff" textsize="0.6" z-index="1" />
            <label pos="88 0" valign="center" size="30 3" halign="center" text="local" textcolor="ffff" textsize="0.6" z-index="1" />
            <label pos="96 0" valign="center" size="30 3" halign="center" text="dedi" textcolor="ffff" textsize="0.6" z-index="1" />
            <label class="fav" pos="115 0" valign="center" size="3 3" text="" textcolor="ffff" textsize="0.6" z-index="1" ScriptEvents="1" focusareacolor1="0000" focusareacolor2="0000" />
            <label pos="106 0" valign="center" size="30 3" halign="center" text="♦♦♦♦♦" textcolor="ffff" textsize="0.6" z-index="1" />
            <label class="juke" pos="125 0" valign="center" halign="center" size="12 3" text=" QUEUE" textcolor="ffff" textsize="0.2" z-index="1" ScriptEvents="1" focusareacolor1="{config('colors.ui.header')}3" focusareacolor2="{config('colors.ui.header')}c" />
            <label class="mx" pos="139 0" valign="center" halign="center" size="14 3" text=" MX INFO" textcolor="ffff" textsize="0.2" z-index="1" ScriptEvents="1" focusareacolor1="{config('colors.ui.header')}3" focusareacolor2="{config('colors.ui.header')}c" />
            {if $localPlayer->hasAccess('map.delete')}
            <label class="delete" pos="149 0" valign="center" halign="center" size="4 3" text="" textcolor="ffff" textsize="0.2" z-index="1" ScriptEvents="1" focusareacolor1="f003" focusareacolor2="f00c" />
            {/if}
        </framemodel>

        <framemodel id="QueueItem">
            <label pos="-1" textsize="0.5" size="120 4" text="Mapname"  valign="center" textprefix="$s" />
            <label pos="110" textsize="0.5" size="16 4" text="Requested by player"  valign="center" textprefix="$s" />
            <label pos="48" textsize="0.5" size="120 4" text="Author" valign="center" textprefix="$s" />
            <label pos="83.5" textsize="0.5" size="120 4" text="Local" valign="center" halign="center" textprefix="$s" />
            <label pos="92" textsize="0.5" size="120 4" text="Dedi" valign="center" halign="center" textprefix="$s" />
            <label pos="137" textsize="0.2" size="10 3" text=" Drop" focusareacolor1="f003" focusareacolor2="f00c" ScriptEvents="1" valign="center" halign="center" class="drop" />
            <label pos="144" textsize="0.2" size="3 3" text="" focusareacolor1="{config('colors.ui.header')}3" focusareacolor2="{config('colors.ui.header')}c" ScriptEvents="1" valign="center" halign="center" class="details" />
        </framemodel>

        <frame id="tabs" pos="2 -13" z-index="2">
            <frame data-tab="0" id="maps" hidden="0" scale="0.97" pos="0 -3">
                <label pos="1  6" textsize="1" text="Name" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="52 6" textsize="1" text="Author" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="88 6" textsize="1" text="Local" halign="center" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="96 6" textsize="1" text="Dedi" halign="center" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="106 6" textsize="1" text="Karma" halign="center" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="117 6" textsize="1" text="Favorite" halign="center" scale="0.8" textcolor="{config('colors.ui.header')}" />

                <frame id="map-list-container" pos="0 3" size="152 80">
                    <frame id="map-list">
                        {for $i = 0; $i < esc\Modules\MapList\MapList::getMapsCount() + 20; $i++}
                        <frameinstance pos="0 {$i * -4}" modelid="Map" hidden="1" />
                        {/for}
                    </frame>
                </frame>

                <frame pos="0 -81" z-index="2">
                    <quad id="pagination-box" pos="2 0" size="3.5 3.5" bgcolor="{config('colors.ui.header')|noescape}" valign="center" halign="center" z-index="-1" />

                    {for $i = 0; $i < ceil(esc\Modules\MapList\MapList::getMapsCount() / 20); $i++}
                    <label class="page" pos="{$i * 4 + 2} 0" text="{$i + 1}" size="3.5 3.5" textsize="1" valign="center" halign="center" ScriptEvents="1" focusareacolor1="0001" />
                    {/for}
                </frame>

                <label pos="125 -80.4" halign="right" textsize="0.9" text="Search:" />
                <entry id="searchInput" pos="151 -80" size="25 3.5" halign="right" style="TextValueSmall" name="searchQuery" default="" textsize="1.2" />
            </frame>

            <frame data-tab="1" id="jukebox" hidden="1">
                <label pos="1  2.8" textsize="0.9" text="Name" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="50 2.8" textsize="1" text="Author" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="86 2.8" textsize="1" text="Local" halign="center" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="94 2.8" textsize="1" text="Dedi" halign="center" scale="0.8" textcolor="{config('colors.ui.header')}" />
                <label pos="112 2.8" size="20 5" textsize="0.9" text="requested by" scale="0.8" textcolor="{config('colors.ui.header')}" />

                <frame id="queue-list" pos="2 -2">
                    {for $i=0; $i<21; $i++}
                    <frameinstance pos="0 {$i * -4}" modelid="QueueItem" hidden="1" />
                    {/for}
                </frame>
            </frame>
        </frame>
    </frame>

    <frame id="widget" pos="{config('ui.map.pos.visible')}" data-pos-visible="{config('ui.map.pos.visible')}" data-pos-hidden="{config('ui.map.pos.hidden')}" scale="0.8" size="50 10">
        <label pos="38 -2" z-index="1" size="36 3" text="Map name" halign="right" textcolor="eeee" textsize="1.4"/>
        <label pos="38 -7" z-index="1" size="36 3" text="Author name" halign="right" textcolor="dddd" valign="center" textsize="0.6"/>

        <label pos="45 -5" valign="center" halign="center" textsize="2" size="6 6" text="" textcolor="ffff"/>

        <quad pos="0 0" size="40 10" bgcolor="{config('colors.ui.background')}9" ScriptEvents="1" />
        <quad pos="40 0" size="10 10" bgcolor="{config('colors.ui.header')}e" ScriptEvents="1" />

        <frame id="controls" pos="5 -10.5" z-index="10">
            <quad pos="-5 0" size="40 10" bgcolor="{background_color()|noescape}6" z-index="-1" />
            <quad pos="-5 0" size="40 10" bgcolor="{config('colors.ui.header')}f" z-index="-2" />

            <frame pos="1.7 -5">
                <label class="map-control fav" textsize="1.5" size="13.3 10" text="" z-index="0" halign="center" valign="center" ScriptEvents="1" focusareacolor1="0000" focusareacolor2="{config('colors.ui.header')}9" />
                <label pos="0 1.5" textsize="1.5" size="10 10" text="" z-index="1" halign="center" valign="center" />
                <label pos="0 -2" textsize="1" scale="0.8" size="10 10" text="Add" z-index="1" halign="center" valign="center" />
            </frame>

            <frame pos="15 -5">
                <label class="map-control details" textsize="1.5" size="13.3 10" text="" z-index="0" halign="center" valign="center" ScriptEvents="1" focusareacolor1="0000" focusareacolor2="{config('colors.ui.header')}9" />
                <label pos="0 1.5" textsize="1.5" size="10 10" text="" z-index="1" halign="center" valign="center" />
                <label pos="0 -2" textsize="1" scale="0.8" size="10 10" text="Details" z-index="1" halign="center" valign="center" />
            </frame>

            <frame pos="28.3 -5">
                <label class="map-control list" textsize="1.5" size="13.3 10" text="" z-index="0" halign="center" valign="center" ScriptEvents="1" focusareacolor1="0000" focusareacolor2="{config('colors.ui.header')}9" />
                <label pos="0 1.5" textsize="1.5" size="10 10" text="" z-index="1" halign="center" valign="center" />
                <label pos="0 -2" textsize="1" scale="0.8" size="10 10" text="Maps" z-index="1" halign="center" valign="center" />
            </frame>

        </frame>
    </frame>

    <frame id="delete-dialog" pos="-40 9" z-index="10" hidden="1">
        <quad size="80 20" bgcolor="{config('colors.ui.background')}" opacity="0.9" z-index="-1" />
        <quad size="80 2" bgcolor="{config('colors.ui.header')}" opacity="0.9" z-index="0" />
        <label pos="40 -5" size="76" valign="center" halign="center" text="" textsize="1" z-index="1" />
        <label class="perm" pos="40 -9" size="76" valign="center" halign="center" text=" Delete permanently and from all MatchSettings" data-set="0" textsize="1" z-index="1" scale="0.7" focusareacolor1="0000" focusareacolor2="0000" ScriptEvents="1" hidden="1" />

        <label class="confirm" pos="32 -15" z-index="0" size="15 5" text="YES" ScriptEvents="1" focusareacolor1="07E20099" halign="center" valign="center" textsize="0.5" focusareacolor2="06BD00AA" scriptevents="1"/>
        <label class="cancel" pos="48 -15" z-index="0" size="15 5" text="NO" ScriptEvents="1" focusareacolor1="f009" halign="center" valign="center" textsize="0.5" focusareacolor2="BD0000AA" scriptevents="1"/>
        <quad size="80 20" style="Bgs1" substyle="BgDialogBlur" z-index="-1" />
    </frame>

    <script><!--
#Include "MathLib" as ML
#Include "TextLib" as TL

declare Integer activeTab;
declare CMlFrame tabs;
declare Text[][] maps;
declare Text[][] favorites;

declare Text lastQueueHash;
declare Text lastMapsHash;
declare Text[] CurrentMap;

//Open confirm dialog and return decision
Integer confirm(Text question){
    declare confirmDialogFrame <=> (Page.MainFrame.GetFirstChild("delete-dialog") as CMlFrame);
    declare permLabel <=> (confirmDialogFrame.Controls[3] as CMlLabel);
    declare Integer answer = 0;
    declare Boolean decided = False;

    //show confirm dialog
    confirmDialogFrame.Show();

    //Set question text
    (confirmDialogFrame.Controls[2] as CMlLabel).SetText(question);

    while(!decided){
        yield;

        foreach(event in PendingEvents){
            if(event.Type == CMlScriptEvent::Type::MouseClick && event.Control.HasClass("perm")){
                declare label = (event.Control as CMlLabel);
                declare set = (label.DataAttributeGet("set") == "1");
                if(set){
                    label.DataAttributeSet("set", "0");
                    label.SetText(" Delete permanently and from all MatchSettings");
                    answer = 0;
                }else{
                    label.DataAttributeSet("set", "1");
                    label.SetText(" Delete permanently and from all MatchSettings");
                    answer = 2;
                }
            }
            if(event.Type == CMlScriptEvent::Type::MouseClick && event.Control.HasClass("confirm")){
                if(answer == 0){
                    answer = 1;
                }
                decided = True;
            }
            if(event.Type == CMlScriptEvent::Type::MouseClick && event.Control.HasClass("cancel")){
                answer = 0;
                decided = True;
            }
        }
    }

    //hide confirm dialog
    confirmDialogFrame.Hide();
    permLabel.SetText(" Delete permanently and from all MatchSettings");
    permLabel.DataAttributeSet("set", "0");

    return answer; // 0 = cancel, 1 = delete from current matchsettings, 2 = delete file + from all matchsettings
}

Integer int(Text textInteger){
    return TL::ToInteger(textInteger);
}

Text getStarString(Real rating){
    if(rating == -1){
        return "$666";
    }

    declare Text starString = "";
    declare Real stars = rating / 20.0;
    declare Integer full = ML::FloorInteger(stars);
    declare Real left = stars - full;

    for(i, 0, full - 1){
        starString = starString ^ "$fff";
    }

    if(left >= 0.5){
        starString = starString ^ "$fff";
        full = full + 1;
    }

    for(i, full + 1, 5){
        starString = starString ^ "$666";
    }

    return starString;
}

Text getContainerTarget(Integer page){
    declare pos = page * 80.0 - 2.0;
    declare target = "<frame pos='0 " ^ pos ^ "' />";
    return target;
}

Void goToPage(Integer pagePO){
    declare page = pagePO - 1;
    declare CMlQuad paginationBox <=> (Page.MainFrame.GetFirstChild("pagination-box") as CMlQuad);
    declare CMlFrame mapList <=> (Page.MainFrame.GetFirstChild("map-list") as CMlFrame);
    AnimMgr.Add(mapList, getContainerTarget(page), 400, CAnimManager::EAnimManagerEasing::CubicInOut);
    AnimMgr.Add(paginationBox, "<quad pos='" ^ (page * 4 + 2) ^ " 0' />", 400, CAnimManager::EAnimManagerEasing::CubicInOut);
}

Void enablePages(Integer totalItemsCount){
    declare CMlQuad paginationBox <=> (Page.MainFrame.GetFirstChild("pagination-box") as CMlQuad);
    declare CMlFrame pagination = (paginationBox.Parent as CMlFrame);
    declare Integer pagesEnabled = totalItemsCount / 20;

    for(i, 1, {ceil(esc\Modules\MapList\MapList::getMapsCount() / 20)}){
        (pagination.Controls[i] as CMlLabel).Hide();
    }
    for(i, 1, pagesEnabled + 1){
        (pagination.Controls[i] as CMlLabel).Show();
    }
}

Text[][] arraySort(Text[][] array, Integer column){
    declare Text[Integer] SortedColumn;

    foreach (I => Data in array) {
        SortedColumn[I] = Data[column];
    }

    SortedColumn = SortedColumn.sort();
    declare Text[][] SortedArray;

    foreach (I => Data in SortedColumn) {
        SortedArray.add(array[I]);
    }

    return SortedArray;
}

Text[][] arraySortDesc(Text[][] array, Integer column){
    declare Text[][] SortedArrayDesc;
    declare Text[][] SortedArray = arraySort(array, column);

    for(i, 1, SortedArray.count){
        SortedArrayDesc.add(SortedArray[SortedArray.count - i]);
    }

    return SortedArrayDesc;
}

Void updateMapFav(Text mapId, Text isFav){
    foreach(i => map in maps){
        if(map[5] == mapId){
            maps[i][6] = isFav;
            return;
        }
    }
}

Text[] getMapById(Text mapId){
    foreach(map in maps){
        if(map[5] == mapId){
            return map;
        }
    }

    return [""];
}

Text[][] getFavorites(){
    declare Text[][] favs;

    foreach(map in maps){
        if(map[6] == "1"){
            favs.add(map);
        }
    }

    return favs;
}

Void updateMapText(CMlFrame mapFrame, Text[] map, Integer arrayIndex){
    mapFrame.DataAttributeSet("map-id", "" ^ map[5]);
    mapFrame.DataAttributeSet("map-name", "" ^ map[0]);

    (mapFrame.Controls[4] as CMlLabel).SetText(map[0]);
    (mapFrame.Controls[5] as CMlLabel).SetText(map[1]);
    (mapFrame.Controls[5] as CMlLabel).ToolTip = map[2];
    (mapFrame.Controls[6] as CMlLabel).SetText(map[3]);
    (mapFrame.Controls[7] as CMlLabel).SetText(map[4]);
    (mapFrame.Controls[9] as CMlLabel).SetText(getStarString(TL::ToReal(map[8])));

    if(map[6] == "1"){
        (mapFrame.Controls[8] as CMlLabel).SetText("");
    }else{
        (mapFrame.Controls[8] as CMlLabel).SetText("");
    }

    mapFrame.Visible = True;
}

Void populate(Text[][] maps){
    declare CMlFrame mapList <=> (Page.MainFrame.GetFirstChild("map-list") as CMlFrame);

    foreach(mapRow in mapList.Controls){
        mapRow.Visible = False;
    }

    for(i, 0, maps.count - 1){
        declare map = maps[i];
        declare mapFrame = (mapList.Controls[i] as CMlFrame);
        updateMapText(mapFrame, map, i);
    }

    enablePages(maps.count);
}

Void navButtonClick(CMlQuad button){
    declare CMlFrame navbar <=> (Page.MainFrame.GetFirstChild("navbar") as CMlFrame);
    declare Integer tab = int(button.DataAttributeGet("page"));

    for(i, 0, navbar.Controls.count - 1){
        ((navbar.Controls[i] as CMlFrame).Controls[0] as CMlQuad).Opacity = 0.2;
    }

    foreach(tabFrame in tabs.Controls){
        tabFrame.Visible = False;
    }

    if(tab == 0){
        //map list
        populate(maps);
        tabs.Controls[0].Visible = True;
    }
    if(tab == 1){
        //favorites
        populate(getFavorites());
        tabs.Controls[0].Visible = True;
        goToPage(1);
    }
    if(tab == 2){
        //jukebox/map queue
        tabs.Controls[1].Visible = True;
    }

    button.Opacity = 1.0;
    activeTab = int(button.DataAttributeGet("page"));
}

Void search(Text query){
    declare Text[][] foundMaps;

    foreach(map in maps){
        if(TL::Find(query, map[0] ^ map[1] ^ map[2], False, False)){
            foundMaps.add(map);
        }
    }

    populate(foundMaps);
}

Void updateQueueItem(CMlControl queueFrameControl, Text[] data, Integer i){
    declare frame <=> (queueFrameControl as CMlFrame);
    declare map = getMapById(data[0]);

    frame.Visible = True;
    frame.DataAttributeSet("map-id", data[0]);
    (frame.Controls[0] as CMlLabel).SetText(map[0]);
    (frame.Controls[1] as CMlLabel).SetText(data[1]);
    (frame.Controls[2] as CMlLabel).SetText(map[1]);
    (frame.Controls[3] as CMlLabel).SetText(map[3]);
    (frame.Controls[4] as CMlLabel).SetText(map[4]);

    //drop-button
    declare Boolean canDrop = ({$localPlayer->hasAccess('queue.drop') ? 'True' : 'False'|noescape} || data[1] == LocalUser.Name);
    (frame.Controls[5] as CMlLabel).Visible = canDrop;
}

Void updateMapQueue(Text[][] items){
    declare queueList <=> (Page.MainFrame.GetFirstChild("queue-list") as CMlFrame);

    foreach(control in queueList.Controls){
        control.Visible = False;
    }

    declare Integer lastIteration = items.count;

    lastIteration = lastIteration - 1;

    for(i, 0, lastIteration){
        updateQueueItem(queueList.Controls[i], items[i], i + 1);
    }
}

Void updateCurrentMap(Text newMapUid){
    foreach(map in maps){
        if(newMapUid == map[7]){
            CurrentMap = map;
            return;
        }
    }

    CurrentMap = ["failed to get mapinfo","failed to get mapinfo","failed to get mapinfo","failed to get mapinfo","failed to get mapinfo","failed to get mapinfo","failed to get mapinfo"];
    log("Map not found!! " ^ newMapUid);
    return;
}

{(new esc\Classes\HideScript())|noescape}

main() {
    maps = {$maps|noescape};
    tabs <=> (Page.MainFrame.GetFirstChild("tabs") as CMlFrame);
    declare CMlFrame mapsContainer <=> (Page.MainFrame.GetFirstChild("maps-container") as CMlFrame);
    declare CMlQuad paginationBox <=> (Page.MainFrame.GetFirstChild("pagination-box") as CMlQuad);
    declare CMlFrame mapListContainer <=> (Page.MainFrame.GetFirstChild("map-list-container") as CMlFrame);
    declare CMlFrame mapList <=> (Page.MainFrame.GetFirstChild("map-list") as CMlFrame);
    declare CMlFrame navbar <=> (Page.MainFrame.GetFirstChild("navbar") as CMlFrame);
    declare CMlFrame widgetControls <=> (Page.MainFrame.GetFirstChild("controls") as CMlFrame);
    declare searchInput <=> (Page.MainFrame.GetFirstChild("searchInput") as CMlEntry);

    //hidescript declarations
    declare CMlFrame widget <=> (Page.MainFrame.GetFirstChild("widget") as CMlFrame);
    declare CMlQuad background <=> (widget.Controls[3] as CMlQuad);
    declare CMlQuad backgroundIcon <=> (widget.Controls[4] as CMlQuad);
    declare Text visible = "<frame pos='" ^ widget.DataAttributeGet("pos-visible") ^ "' />";
    declare Text hidden = "<frame pos='" ^ widget.DataAttributeGet("pos-hidden") ^ "' />";
    declare Boolean isHidden = False;

    //current map detection
    declare Text currentMapId = "";

    populate(maps);
    activeTab = 0;
    goToPage(1);

    declare Text lastMapSearchQueryHash = "";
    declare Boolean controlsVisible = False;

    ((navbar.Controls[0] as CMlFrame).Controls[0] as CMlQuad).Opacity = 1.0;

    while(True){
        yield;

        hidescript();

        if(InputPlayer != Null){
            //map change detection
            if(Map.MapInfo.MapUid != currentMapId){
                currentMapId = Map.MapInfo.MapUid;
                updateCurrentMap(Map.MapInfo.MapUid);
                wait(CurrentMap.count > 0);
                (widget.Controls[0] as CMlLabel).SetText(CurrentMap[0]);
                (widget.Controls[1] as CMlLabel).SetText(CurrentMap[1]);

                if(CurrentMap[6] == "1"){
                    ((widgetControls.Controls[2] as CMlFrame).Controls[1] as CMlLabel).SetText("");
                    ((widgetControls.Controls[2] as CMlFrame).Controls[2] as CMlLabel).SetText("Remove");
                }else{
                    ((widgetControls.Controls[2] as CMlFrame).Controls[1] as CMlLabel).SetText("");
                    ((widgetControls.Controls[2] as CMlFrame).Controls[2] as CMlLabel).SetText("Add");
                }
            }

            //search command
            declare Text MapSearchQueryHash for InputPlayer;
            declare Text MapSearchQuery for InputPlayer;

            if(lastMapSearchQueryHash != MapSearchQueryHash){
                lastMapSearchQueryHash = MapSearchQueryHash;
                mapsContainer.Show();
                searchInput.SetText(MapSearchQuery, True);
            }

            declare x_min = widget.RelativePosition_V3[0];
            declare x_max = widget.RelativePosition_V3[0] + (widget.Size[0] * widget.RelativeScale);
            declare y_min = widget.RelativePosition_V3[1];
            declare y_max = widget.RelativePosition_V3[1] - (widget.Size[1] * widget.RelativeScale);
            declare Boolean xInBounds = (MouseX > x_min && MouseX < x_max);
            declare Boolean yInBounds = (MouseY < y_min && MouseY > y_max);

            if(!(xInBounds && yInBounds) && controlsVisible){
                controlsVisible = False;
                AnimMgr.Add(widgetControls, " <frame pos='5.0 -10.5' /> ", 150, CAnimManager::EAnimManagerEasing::QuadOut);
            }
            if((xInBounds && yInBounds) && !controlsVisible){
                controlsVisible = True;
                AnimMgr.Add(widgetControls, " <frame pos='5.0 0.0' /> ", 150, CAnimManager::EAnimManagerEasing::QuadOut);
            }

            foreach(event in PendingEvents){
                if(event.Control == Null){
                    continue;
                }

                if(event.Control.HasClass("map-control") && event.Type == CMlScriptEvent::Type::MouseClick){
                    if(event.Control.HasClass("fav")){
                        declare curMapId = CurrentMap[5];
                        declare isFavCurrent = getMapById(curMapId)[6] == "1";
                        if(isFavCurrent){
                            updateMapFav(curMapId, "0");
                            TriggerPageAction("map.fav.remove," ^ CurrentMap[5]);
                            ((widgetControls.Controls[2] as CMlFrame).Controls[1] as CMlLabel).SetText("");
                            ((widgetControls.Controls[2] as CMlFrame).Controls[2] as CMlLabel).SetText("Add");
                            continue;
                        }else{
                            updateMapFav(curMapId, "1");
                            TriggerPageAction("map.fav.add," ^ CurrentMap[5]);
                            ((widgetControls.Controls[2] as CMlFrame).Controls[1] as CMlLabel).SetText("");
                            ((widgetControls.Controls[2] as CMlFrame).Controls[2] as CMlLabel).SetText("Remove");
                            continue;
                        }
                        if(activeTab == 1){
                            populate(getFavorites());
                        }
                    }
                    if(event.Control.HasClass("details")){
                        TriggerPageAction("mx.details," ^ CurrentMap[5]);
                    }
                    if(event.Control.HasClass("list")){
                        navButtonClick(((navbar.Controls[0] as CMlFrame).Controls[0] as CMlQuad));
                        mapsContainer.Show();
                    }
                    continue;
                }

                if(event.Control == searchInput){
                    search(searchInput.Value);
                    continue;
                }

                if(event.Control.HasClass("nav-button")){
                    declare button = (event.Control as CMlQuad);

                    if(int(button.DataAttributeGet("page")) == activeTab){
                        continue;
                    }

                    switch(event.Type){
                        case CMlScriptEvent::Type::MouseClick: navButtonClick(button);
                        case CMlScriptEvent::Type::MouseOver: button.Opacity = 0.6;
                        case CMlScriptEvent::Type::MouseOut: button.Opacity = 0.2;
                    }

                    continue;
                }

                if(event.Control.Parent.Controls[0].HasClass("row")){
                    declare row = (event.Control.Parent.Controls[0] as CMlQuad);

                    if(event.Type == CMlScriptEvent::Type::MouseOver){
                        row.Opacity = 0.5;
                    }
                    if(event.Type == CMlScriptEvent::Type::MouseOut){
                        row.Opacity = 0.0;
                    }
                }

                if(event.Control.HasClass("fav")){
                    if(event.Type == CMlScriptEvent::Type::MouseClick){
                        declare mapId = (event.Control as CMlLabel).Parent.DataAttributeGet("map-id");
                        declare isFav = getMapById(mapId)[6] == "1";

                        if(isFav){
                            TriggerPageAction("map.fav.remove," ^ mapId);
                            updateMapFav(mapId, "0");
                        }else{
                            TriggerPageAction("map.fav.add," ^ mapId);
                            updateMapFav(mapId, "1");
                        }

                        if(activeTab == 0){
                            populate(maps);
                        }
                        if(activeTab == 1){
                            populate(getFavorites());
                        }
                    }

                    continue;
                }

                if(event.Control.HasClass("juke")){
                    if(event.Type == CMlScriptEvent::Type::MouseClick){
                        declare mapId = (event.Control as CMlLabel).Parent.DataAttributeGet("map-id");
                        TriggerPageAction("map.queue," ^ mapId);
                    }

                    continue;
                }

                if(event.Control.HasClass("mx")){
                    if(event.Type == CMlScriptEvent::Type::MouseClick){
                        declare mapId = (event.Control as CMlLabel).Parent.DataAttributeGet("map-id");
                        TriggerPageAction("mx.details," ^ mapId);
                    }

                    continue;
                }

                if(event.Control.HasClass("row")){
                    declare row = (event.Control as CMlQuad);

                    if(event.Type == CMlScriptEvent::Type::MouseOver){
                        row.Opacity = 0.5;
                    }
                    if(event.Type == CMlScriptEvent::Type::MouseOut){
                        row.Opacity = 0.0;
                    }

                    continue;
                }

                if(event.Control.HasClass("close") && event.Type == CMlScriptEvent::Type::MouseClick){
                    mapsContainer.Hide();
                    continue;
                }

                if(event.Control.HasClass("page") && event.Type == CMlScriptEvent::Type::MouseClick){
                    goToPage(TL::ToInteger((event.Control as CMlLabel).Value));
                    continue;
                }

                if(event.Control.HasClass("drop") && event.Type == CMlScriptEvent::Type::MouseClick){
                    declare mapId = event.Control.Parent.DataAttributeGet("map-id");
                    TriggerPageAction("map.drop," ^ mapId);
                    continue;
                }

                if(event.Control.HasClass("details") && event.Type == CMlScriptEvent::Type::MouseClick){
                    declare mapId = event.Control.Parent.DataAttributeGet("map-id");
                    TriggerPageAction("mx.details," ^ mapId);
                    continue;
                }

                if(event.Control.HasClass("delete") && event.Type == CMlScriptEvent::Type::MouseClick){
                    declare mapFrame = (event.Control.Parent as CMlFrame);
                    declare answer = confirm("Do you really want to delete " ^ mapFrame.DataAttributeGet("map-name") ^ "?");
                    if(answer == 1){
                        TriggerPageAction("maplist.delete," ^ mapFrame.DataAttributeGet("map-id"));
                    }
                    if(answer == 2){
                        TriggerPageAction("maplist.delete-perm," ^ mapFrame.DataAttributeGet("map-id"));
                    }
                }

                if(event.Control.HasClass("page") && event.Type == CMlScriptEvent::Type::MouseClick){
                    goToPage(TL::ToInteger((event.Control as CMlLabel).Value));
                    continue;
                }
            }

            declare Text QueueHash for InputPlayer;
            if(lastQueueHash != QueueHash){
                declare Text[][] QueuedMaps for InputPlayer;
                updateMapQueue(QueuedMaps);
                lastQueueHash = QueueHash;
            }

            declare Text MapsHash for InputPlayer;
            if(lastMapsHash != MapsHash){
                declare Text[][] Maps for InputPlayer;
                maps = Maps;
                populate(maps);
                lastMapsHash = MapsHash;
            }
        }
    }
}
    --></script>
</manialink>